<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mood History | Emotional Support Bot</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='moodTrends.css') }}">
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    


  </style>
</head>
<body>

  <!-- inject server avatar variables for client JS -->
  <script>
    window.profileAvatar = {{ profile_avatar|tojson if profile_avatar is not none else 'null' }};
    window.isInitials = {{ 'true' if is_initials else 'false' }};
    window.userName = {{ user_name|tojson if user_name is not none else 'null' }};
  </script>

   <!-- Sidebar Navigation -->
  <aside class="sidebar">
    <div class="top-section">
      <div class="logo">
        <img src="{{ url_for('static', filename='images/esb-logo.jpg') }}" alt="logo">
      </div>
      <nav class="nav-icons">
        <a href="{{ url_for('dashboard') }}" title="Dashboard"><i class="fas fa-home"></i></a>
        <a href="{{ url_for('mood_analysis') }}" title="Mood Analysis"><i class="fas fa-chart-bar"></i></a>
        <a href="{{ url_for('chat') }}" title="Chatbot"><i class="fas fa-comment-dots"></i></a>
        <a href="{{ url_for('mood_trends') }}" title="Mood Calendar"><i class="fas fa-calendar-alt"></i></a>
      </nav>
    </div>
    <!-- Sidebar bottom avatar -->
    <a href="{{ url_for('settings') }}" title="Profile Settings">
      {% if is_initials %}
        <div class="avatar avatar-initials">{{ profile_avatar }}</div>
      {% else %}
        <img src="{{ profile_avatar }}" class="avatar" alt="Profile Avatar" />
      {% endif %}
    </a>
  </aside> 

  <main>
    <header class="top-nav">
      <div class="logo-text">ESB</div>
      <div class="center-icons">
        <i class="fas fa-sun" id="lightModeToggle" title="Light Mode"></i>
        <i class="fas fa-moon" id="darkModeToggle" title="Dark Mode"></i>
      </div>

      <div class="right-avatar">
        {% if not is_initials %}
          <img src="{{ profile_avatar }}" alt="Profile Avatar" />
        {% else %}
          <div class="avatar-initials" style="width:40px;height:40px;font-size:16px;">
            {{ (user_name or 'U')[:1] }}
          </div>
        {% endif %}
      </div>
    </header>

    <div class="circle-bg bg1"></div>
    <div class="circle-bg bg2"></div>
    <div class="circle-bg bg3"></div>

    <div class="glass-card" style="margin-top:88px;">
      <div class="date-row" id="date-row">
        {% for day in mood_days %}
          <button class="date-pill{% if day.day == selected_day %} selected{% endif %}" 
            data-date="{{ day.date }}" onclick="selectPeriod('day', '{{ day.date }}', this)">
            {{ day.label }}<br>{{ day.day }}
          </button>
        {% endfor %}
        <div class="dropdown">
          <button class="weekly-btn" id="period-btn">
            <span id="selected-period-text">Weekly</span>
          </button>
          <div class="dropdown-content">
            <button onclick="selectPeriod('week', null, this)" class="selected" id="week-btn">Weekly</button>
            <button onclick="selectPeriod('month', null, this)" id="month-btn">Monthly</button>
            <button onclick="selectPeriod('year', null, this)" id="year-btn">Yearly</button>
          </div>
        </div>
      </div>

      <!-- Mood Label & Summary -->
      <div class="section-header" id="mood-label">{{ mood_label }}</div>
      <div class="mood-box" id="mood-label-box">
        <strong>Overall Confidence Score: <span id="confidence-score">{{ confidence_score }}</span>/10</strong>
        <ul id="mood-label-ul">
          {% for item in mood_summary %}
            <li>{{ item }}</li>
          {% endfor %}
        </ul>
      </div>

      <div class="section-header">Quick Tips to Improve:</div>
      <div class="mood-box" id="tips-box">
        <ul id="tips-ul">
          {% for tip in tips %}
            <li><span class="tip-check">✅</span>{{ tip }}</li>
          {% endfor %}
        </ul>
      </div>

      <div class="section-header" style="margin-top:38px;">Mood Trends</div>
       <!-- MOOD TRENDS CARD with inner chart scroller -->
      <div class="mood-trends-card">
        <div class="bar-chart" id="bar-chart">
          {% for i in range(mood_trends|length) %}
            <div class="bar-item">
              <div class="bar {% if mood_trends_classes is defined %}{{ mood_trends_classes[i] }}{% endif %}" style="height:{{ mood_trends[i]|int }}px;">
                <div class="bar-tooltip">{{ mood_trends[i] }}</div>
              </div>
              <div class="bar-label">{{ mood_trends_labels[i] }}</div>
            </div>
          {% endfor %}
        </div>
      </div>

      <div class="section-header" style="margin-top:18px;">Your Overall Mood This Period</div>
      <div class="mood-pie-row">
        <div class="mood-legend-box" id="legend-box">
          {% for mood in overall_mood %}
            <div class="mood-legend-item"><span class="legend-swatch {{ mood.color }}"></span>{{ mood.percent }}% {{ mood.label }}</div>
          {% endfor %}
        </div>
        <div class="donut-chart-wrap">
          <div class="donut-chart">
            <span class="donut-inner-text" id="donut-label">{{ donut_label|safe }}</span>
            <svg viewBox="0 0 42 42" class="donut-svg" id="donut-svg">
              {% set offset = 0 %}
              {% for seg in donut_data %}
                <circle
                  class="donut-segment {{ seg.class }}"
                  cx="21" cy="21" r="15.9155"
                  stroke-width="4"
                  fill="none"
                  stroke-dasharray="{{ seg.percent }} {{ 100-seg.percent }}"
                  stroke-dashoffset="-{{ offset }}"
                />
                {% set offset = offset + seg.percent %}
              {% endfor %}
            </svg>
          </div>
        </div>
      </div>

    </div>
  </main>
  <script>
 let currentPeriod = 'week';
    let selectedDate = null;

    function formatConfidenceRaw(raw) {
      // If server gave 0-10 number, convert to percentage string
      if (raw === null || raw === undefined) return '';
      const n = Number(raw);
      if (isNaN(n)) return raw;
      if (n <= 10) {
        return Math.round((n / 10) * 100) + '%';
      }
      // If already a percent or bigger number, show as-is
      return (n % 1 === 0 ? n : n.toFixed(1)) + (String(raw).includes('%') ? '' : '');
    }

    function selectPeriod(period, date, el) {
      currentPeriod = period;
      selectedDate = date;

      // Update period button text
      const txt = period === 'day' ? 'Day' : period === 'week' ? 'Weekly' : period === 'month' ? 'Monthly' : 'Yearly';
      document.getElementById('selected-period-text').innerText = txt;

      // Highlight dropdown item
      document.querySelectorAll('.dropdown-content button').forEach(btn => btn.classList.remove('selected'));
      if (period === 'week') document.getElementById('week-btn').classList.add('selected');
      if (period === 'month') document.getElementById('month-btn').classList.add('selected');
      if (period === 'year') document.getElementById('year-btn').classList.add('selected');

      // Highlight day pill if selected (search inside scroller)
      document.querySelectorAll('#date-row-scroll .date-pill').forEach(btn => btn.classList.remove('selected'));
      if (period === 'day' && el) el.classList.add('selected');

      // Fetch data from backend and update
      fetchTrends(period, date);
    }

    function fetchTrends(period, date) {
      let postData = { view_type: period };
      if (period === 'day' && date) postData['date'] = date;
      fetch('/get-mood-trends', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(postData)
      }).then(resp => {
        if (!resp.ok) throw new Error('Network response was not ok');
        return resp.json();
      }).then(data => {
        updateTrends(data);
      }).catch(err => {
        console.error('Failed to fetch trends:', err);
      });
    }

function updateTrends(data) {
  // 1) Bar chart
// build inner wrapper (outer .bar-chart must keep overflow-x:auto)
const barChart = document.getElementById('bar-chart');
barChart.innerHTML = '';

const inner = document.createElement('div');
inner.className = 'bar-chart-inner';
barChart.appendChild(inner);

// append all bar-items into inner
for (let i = 0; i < data.mood_trends.length; i++) {
  const heightPx = parseInt(data.mood_trends[i]) || 0;
  const lbl = (data.mood_trends_labels && data.mood_trends_labels[i]) ? data.mood_trends_labels[i] : '';
  const cls = (data.mood_trends_classes && data.mood_trends_classes[i]) ? data.mood_trends_classes[i] : '';

  const item = document.createElement('div');
  item.className = 'bar-item';
  item.innerHTML = `
    <div class="bar ${cls}" style="height:${heightPx}px;">
      <div class="bar-tooltip">${heightPx}</div>
    </div>
    <div class="bar-label">${lbl}</div>`;
  inner.appendChild(item);
}

// make the inner wrapper exactly as wide as its contents so the outer scrollbar covers everything
setTimeout(() => {
  const required = inner.scrollWidth;          // total width of all bars
  inner.style.width = required + 'px';         // force inner width -> scrollbar will map to full range
  // optionally ensure view starts at left:
  barChart.scrollLeft = 0;
  // or to show latest (rightmost): barChart.scrollLeft = barChart.scrollWidth;
}, 0);


  // 2) Mood label & confidence
  if (data.mood_label !== undefined) document.getElementById('mood-label').innerText = data.mood_label;
  if (data.confidence_score !== undefined) {
    document.getElementById('confidence-score').innerText = formatConfidenceRaw(data.confidence_score);
  }

  // 3) Mood summary list
  const mLabelUl = document.getElementById('mood-label-ul');
  mLabelUl.innerHTML = '';
  if (Array.isArray(data.mood_summary)) {
    data.mood_summary.forEach(s => {
      const li = document.createElement('li');
      li.innerText = s;
      mLabelUl.appendChild(li);
    });
  }

  // 4) Tips
  const tipsUl = document.getElementById('tips-ul');
  tipsUl.innerHTML = '';
  if (Array.isArray(data.tips)) {
    data.tips.forEach(tip => {
      const li = document.createElement('li');
      li.innerHTML = `<span class="tip-check">✅</span>${tip}`;
      tipsUl.appendChild(li);
    });
  }

  // 5) Legend
  const legendBox = document.getElementById('legend-box');
  legendBox.innerHTML = '';
  if (Array.isArray(data.overall_mood)) {
    data.overall_mood.forEach(mood => {
      const div = document.createElement('div');
      div.className = 'mood-legend-item';
      div.innerHTML = `<span class="legend-swatch ${mood.color}"></span>${mood.percent}% ${mood.label}`;
      legendBox.appendChild(div);
    });
  }

  // 6) Donut
  if (data.donut_label !== undefined) document.getElementById('donut-label').innerHTML = data.donut_label;
  if (Array.isArray(data.donut_data)) {
    let offset = 0, svg = '';
    data.donut_data.forEach(seg => {
      svg += `<circle class="donut-segment ${seg.class}" cx="21" cy="21" r="15.9155" stroke-width="4" fill="none"
        stroke-dasharray="${seg.percent} ${100-seg.percent}" stroke-dashoffset="-${offset}" />`;
      offset += seg.percent;
    });
    document.getElementById('donut-svg').innerHTML = svg;
  }
}

    // Initial setup
    document.addEventListener("DOMContentLoaded", function() {
      // Convert any server-provided confidence_score (initial render) to percent if needed
      const confNode = document.getElementById('confidence-score');
      if (confNode) {
        const raw = confNode.innerText.trim();
        if (raw.length) confNode.innerText = formatConfidenceRaw(raw);
      }
      // default to weekly
      selectPeriod('week', null, document.getElementById('week-btn'));
    });





    /* adapt bar column width based on number of bars (keeps scrolling usable) */
function adaptBarWidths() {
  const bc = document.getElementById('bar-chart');
  if (!bc) return;
  const items = bc.querySelectorAll('.bar-item');
  const count = items.length;
  let basis = 48; // default column width

  if (count > 40) basis = 34;
  else if (count > 30) basis = 38;
  else if (count > 20) basis = 42;
  else basis = 48;

  items.forEach(it => it.style.flex = `0 0 ${basis}px`);
}
  // Theme toggle with two always-visible buttons for light and dark mode

function setTheme(mode) {
  if (mode === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
    localStorage.setItem('themeMode', 'light');
  } else {
    document.documentElement.setAttribute('data-theme', 'dark');
    localStorage.setItem('themeMode', 'dark');
  }
}

function getPreferredTheme() {
  const stored = localStorage.getItem('themeMode');
  if (stored) return stored;
  return window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
}

document.addEventListener('DOMContentLoaded', function () {
  // Set initial theme
  setTheme(getPreferredTheme());

  // Attach click handlers to both buttons
  document.getElementById('lightModeToggle').addEventListener('click', function () {
    setTheme('light');
  });

  document.getElementById('darkModeToggle').addEventListener('click', function () {
    setTheme('dark');
  });
});  
  </script>
</body>
</html>