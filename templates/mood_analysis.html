{% macro mood_summary_bubble(mood_label, sentiment, confidence, explanation, recommendations, timestamp) %}
<div class="chat-message bot-message mood-summary-bubble">
  <div class="avatar-label">ESB</div>
  <div class="message-bubble">
    <div style="margin-bottom:8px;">
      <span style="font-weight:bold; color:#2b8ad6;">Mood:</span> {{ mood_label }} &nbsp; | &nbsp;
      <span style="font-weight:bold; color:#6c757d;">Sentiment:</span> {{ sentiment }} &nbsp; | &nbsp;
      <span style="font-weight:bold; color:#ffc107;">Confidence:</span> {{ (confidence * 100) | round(2) }}%
    </div>
    <hr style="margin: 8px 0;">
    <div style="margin-bottom:10px;">
      <strong>Summary:</strong>
      <div>{{ explanation }}</div>
    </div>
    <div style="margin-bottom:10px;">
      <strong>Recommendations:</strong>
      <ul style="margin:0 0 0 20px;">
        {% for rec in recommendations %}
          <li>{{ rec }}</li>
        {% endfor %}
      </ul>
    </div>
    <div class="timestamp">{{ timestamp }}</div>
  </div>
</div>
{% endmacro %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mood Analysis - ESB</title>
      <link rel="icon" href="static/favicon.png" type="image/png">
  <link rel="stylesheet" href="{{ url_for('static', filename='mood_analysis.css') }}">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body>
<script>
  // server-injected variables (safe JSON)
  window.profileAvatar = {{ profile_avatar|tojson if profile_avatar is not none else 'null' }};
  window.isInitials = {{ 'true' if is_initials else 'false' }}; // unquoted boolean-like token
  window.userName = {{ user_name|tojson if user_name is not none else 'null' }};

  // fallback static avatar
  window.defaultAvatarStatic = "{{ url_for('static', filename='images/default_avatar.jpg') }}";

  // normalize for JS usage
  const _isInitials = (window.isInitials === true || window.isInitials === 'true');
  window._isInitials = _isInitials;
  if (!_isInitials && window.profileAvatar) {
    window.currentUserAvatarSrc = window.profileAvatar;
  } else {
    window.currentUserAvatarSrc = window.defaultAvatarStatic;
  }
</script>

<aside class="sidebar">
  <div class="top-section">
    <div class="logo">
      <!-- corrected filename (no leading slash) -->
      <img src="{{ url_for('static', filename='images/esb-logo.jpg') }}" alt="logo">
    </div>
    <nav class="nav-icons">
      <a href="{{ url_for('dashboard') }}" title="Dashboard"><i class="fas fa-home"></i></a>
      <a href="{{ url_for('mood_trends') }}" title="Mood Trends"><i class="fas fa-chart-bar"></i></a>
      <a href="{{ url_for('chat') }}" title="Chatbot"><i class="fas fa-comment-dots"></i></a>
      <a href="{{ url_for('mood_trends') }}" title="Calendar"><i class="fas fa-calendar-alt"></i></a>
    </nav>
  </div>

  <div class="bottom-section">
    <a href="{{ url_for('settings') }}" title="Profile Settings" class="profile-link">
      {% if not is_initials %}
        <img src="{{ profile_avatar }}" class="avatar user-avatar" alt="Profile Avatar">
      {% else %}
        <div class="avatar avatar-initials">{{ profile_avatar }}</div>
      {% endif %}
    </a>
  </div>
</aside>

<section class="side-panel">
  <header class="left-nav">
    <div class="logo-text">Mood Analysis</div>
  </header>

  <form method="POST" action="{{ url_for('reanalyze_mood') }}">
    <button class="reanalyze-button">
      <i class="fas fa-sync-alt"></i> Reanalyze Mood
    </button>
  </form>

  <div class="chat-history">
    {% for session in session_list %}
      <div class="chat-history-item">
        <a
          href="{{ url_for('mood_analysis', session_id=session.id) }}"
          class="chat-history-btn {% if session.id == chat_session_id %}active{% endif %}"
          title="{{ session.time.strftime('%b %d, %Y %H:%M') }}"
        >
          {{ session.topic }}
        </a>
        <button class="delete-chat-btn" data-session-id="{{ session.id }}">Ã—</button>
      </div>
    {% endfor %}
  </div>

  <div class="bottom-buttons">
    <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a>
    <a href="{{ url_for('feedback_form') }}"><i class="fas fa-comment-alt"></i> Feedback</a>
    <a href="{{ url_for('help_page') }}"><i class="fas fa-question-circle"></i> Help</a>
  </div>
</section>

<main class="main-content" style="display: flex; flex-direction: column; height: 100vh;">
  <header class="top-nav">
    <div class="logo-text">ESB</div>
    <div class="center-icons">
      <i class="fas fa-sun" id="lightModeToggle" title="Light Mode"></i>
      <i class="fas fa-moon" id="darkModeToggle" title="Dark Mode"></i>
    </div>
    <div class="right-avatar">
      {% if not is_initials %}
        <img src="{{ profile_avatar }}" class="user-avatar" alt="Profile Avatar">
      {% else %}
        <div class="avatar avatar-initials">{{ profile_avatar }}</div>
      {% endif %}
    </div>
  </header>

  <div class="chat-window" id="chatWindow">
    <div id="qa-history">
      {% for msg in chat_history %}
        {% if msg.sender == 'bot' and msg.get('type') == 'mood_summary' %}
          {{ mood_summary_bubble(
            msg.mood_label,
            msg.sentiment,
            msg.confidence,
            msg.explanation,
            msg.recommendations,
            msg.timestamp
          ) }}
        {% elif msg.sender == 'bot' %}
          <div class="chat-message bot-message">
            <div class="avatar-label">ESB</div>
            <div class="message-bubble">
              {{ msg.message|safe }}
              <div class="timestamp">{{ msg.timestamp }}</div>
            </div>
          </div>
        {% elif msg.sender == 'user' %}
          <div class="chat-message user-message">
            <div class="avatar-col">
              {% if not is_initials %}
                <img class="user-avatar" src="{{ profile_avatar }}" alt="User Avatar">
              {% else %}
                <div class="avatar-label">{{ (user_name or 'U')[:1] }}</div>
              {% endif %}
            </div>
            <div class="message-bubble">
              {{ msg.message|nl2br }}
              <div class="timestamp">{{ msg.timestamp }}</div>
            </div>
          </div>
        {% endif %}
      {% endfor %}

      {% if question and (chat_history|length) == 0 %}
        <div class="chat-message bot-message">
          <div class="avatar-label">ESB</div>
          <div class="message-bubble">
            {{ question }}
            <div class="timestamp">Just now</div>
          </div>
        </div>
      {% endif %}
    </div>

    <div id="wait-msg" style="display:none;" class="typing-bubble">
      <span class="typing-text">Generating mood analysis</span>
      <span class="typing-dots"><span></span><span></span><span></span></span>
    </div>

    <div id="scroll-anchor" style="height: 80px;"></div>
  </div>

  {% if allow_chat %}
    <div class="chat-input-bar" id="chatInputBar"
         data-question-index="{{ question_index }}"
         data-total-questions="{{ total_questions }}">
      <form id="moodChatForm" class="chat-form">
        <textarea id="chatInput" class="chat-input" name="answer" placeholder="Type a message..." required autofocus></textarea>
        <button type="button" id="micButton" class="mic-button">
          <i class="fas fa-microphone" id="micIcon"></i>
        </button>
        <button type="submit" class="send-button" id="sendButton">
          <i class="fas fa-paper-plane"></i>
        </button>
      </form>
    </div>
  {% endif %}
</main>

<script>
  // --- Theme toggles ---
  const allow_chat = typeof window.allow_chat !== "undefined" ? window.allow_chat : true;
  const lightToggle = document.getElementById("lightModeToggle");
  const darkToggle = document.getElementById("darkModeToggle");
  if (localStorage.getItem("theme") === "light") {
    document.body.classList.add("light-mode");
  }
  lightToggle.addEventListener("click", () => {
    document.body.classList.add("light-mode");
    localStorage.setItem("theme", "light");
  });
  darkToggle.addEventListener("click", () => {
    document.body.classList.remove("light-mode");
    localStorage.setItem("theme", "dark");
  });

  function scrollToBottom() {
    const chatWindow = document.getElementById('chatWindow');
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }
  window.addEventListener('load', function() {
    focusChatInput();
    scrollToBottom();
  });

  function focusChatInput() {
    const textarea = document.getElementById('chatInput');
    if (textarea) {
      textarea.focus();
      textarea.setSelectionRange(textarea.value.length, textarea.value.length);
    }
  }

  // --- Enter sends, Shift+Enter = newline ---
  if (allow_chat) {
    const chatForm = document.getElementById('moodChatForm');
    const textarea = document.getElementById('chatInput');
    textarea.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chatForm.dispatchEvent(new Event('submit'));
      }
    });
    chatForm.addEventListener('submit', () => {
      setTimeout(scrollToBottom, 50);
    });
  }

  // --- Delete mood session via AJAX (matches your backend route /delete-mood/<id>) ---
  function attachDeleteHandlers() {
    document.querySelectorAll('.delete-chat-btn').forEach(button => {
      button.addEventListener('click', () => {
        const sessionId = button.getAttribute('data-session-id');
        fetch(`/delete-mood/${sessionId}`, {
          method: 'DELETE',
        })
        .then(response => {
          if (response.ok) updateMoodSessionList();
          else console.error("Failed to delete mood session");
        })
        .catch(error => console.error("Error deleting mood session:", error));
      });
    });
  }
  attachDeleteHandlers();

  // --- Update mood session sidebar instantly ---
  function updateMoodSessionList() {
    fetch('/api/mood-session-list')
      .then(resp => resp.json())
      .then(data => {
        if (data.sessions) {
          const historyDiv = document.querySelector('.chat-history');
          let html = '';
          data.sessions.forEach(session => {
            html += `<div class="chat-history-item">
              <a href="/mood-analysis?session_id=${session.id}"
                class="chat-history-btn"
                title="${session.time}">
                ${session.topic}
              </a>
              <button class="delete-chat-btn" data-session-id="${session.id}">&times;</button>
            </div>`;
          });
          historyDiv.innerHTML = html;
          attachDeleteHandlers();
        }
      });
  }

 // Speech recognition logic (unchanged) - kept as-is
let recognition;
let isListening = false;
let finalTranscript = '';
const micButton = document.getElementById('micButton');
const chatInput = document.getElementById('chatInput');
if ('webkitSpeechRecognition' in window) {
  recognition = new webkitSpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = 'en-US';
  recognition.onresult = function(event) {
    let interimTranscript = '';
    let newFinalTranscript = finalTranscript;
    for (let i = event.resultIndex; i < event.results.length; ++i) {
      if (event.results[i].isFinal) {
        newFinalTranscript += event.results[i][0].transcript + ' ';
      } else {
        interimTranscript += event.results[i][0].transcript;
      }
    }
    finalTranscript = newFinalTranscript;
    chatInput.value = finalTranscript + interimTranscript;
    chatInput.style.height = 'auto';
    chatInput.style.height = (chatInput.scrollHeight) + 'px';
  };
  recognition.onerror = function(event) {
    isListening = false;
    micButton.classList.remove('listening');
    chatInput.placeholder = 'Click mic to start speaking...';
  };
  recognition.onspeechend = function() {
    recognition.stop();
    isListening = false;
    micButton.classList.remove('listening');
    chatInput.placeholder = 'Click mic to start speaking...';
  };
  function startListening() {
    if (!isListening) {
      recognition.start();
      isListening = true;
      micButton.classList.add('listening');
      chatInput.placeholder = 'Listening...';
    }
  }
  function stopListening() {
    if (isListening) {
      recognition.stop();
      isListening = false;
      micButton.classList.remove('listening');
      chatInput.placeholder = 'Click mic to start speaking...';
    }
  }
  if (micButton) micButton.addEventListener('click', function() {
    if (isListening) {
      stopListening();
    } else {
      startListening();
    }
  });
  if (chatInput) chatInput.addEventListener('input', function() {
    if (chatInput.value === '') {
      finalTranscript = '';
    }
    chatInput.style.height = 'auto';
    chatInput.style.height = (chatInput.scrollHeight) + 'px';
  });
} else if (!('webkitSpeechRecognition' in window)) {
  
}

  // --- Add chat message to history and scroll (updated to use profile avatar or initials) ---
  function addChatMessage(sender, message, timestamp, isSummary, summaryObj) {
    let qaDiv = document.getElementById('qa-history');
    let msgHtml = '';

    const isInitials = (window._isInitials === true || window._isInitials === 'true');

    if (isSummary && summaryObj) {
      msgHtml = `<div class="chat-message bot-message mood-summary-bubble">
        <div class="avatar-label">ESB</div>
        <div class="message-bubble">
          <div style="margin-bottom:8px;">
            <span style="font-weight:bold; color:#2b8ad6;">Mood:</span> ${summaryObj.mood_label} &nbsp; | &nbsp;
            <span style="font-weight:bold; color:#6c757d;">Sentiment:</span> ${summaryObj.sentiment} &nbsp; | &nbsp;
            <span style="font-weight:bold; color:#ffc107;">Confidence:</span> ${(summaryObj.confidence*100).toFixed(2)}%
          </div>
          <hr style="margin: 8px 0;">
          <div style="margin-bottom:10px;">
            <strong>Summary:</strong>
            <div>${summaryObj.explanation}</div>
          </div>
          <div style="margin-bottom:10px;">
            <strong>Recommendations:</strong>
            <ul style="margin:0 0 0 20px;">${
              (Array.isArray(summaryObj.recommendations) ? summaryObj.recommendations : [summaryObj.recommendations]).map(r=>`<li>${r}</li>`).join('')
            }</ul>
          </div>
          <div class="timestamp">${timestamp}</div>
        </div>
      </div>`;
    } else if (sender === 'bot') {
      msgHtml = `<div class="chat-message bot-message">
        <div class="avatar-label">ESB</div>
        <div class="message-bubble">${message}<div class="timestamp">${timestamp}</div></div>
      </div>`;
    } else {
      // USER MESSAGE: render profile image or initials badge
      let userAvatarHtml = '';
      if (isInitials) {
        const letter = (window.userName && window.userName.length ? window.userName.charAt(0).toUpperCase() : 'U');
        userAvatarHtml = `<div class="avatar-label">${letter}</div>`;
      } else if (window.profileAvatar) {
        userAvatarHtml = `<img class="user-avatar" src="${window.profileAvatar}" alt="User Avatar">`;
      } else {
        userAvatarHtml = `<img class="user-avatar" src="${window.defaultAvatarStatic}" alt="User Avatar">`;
      }

      msgHtml = `<div class="chat-message user-message">
        <div class="avatar-col">${userAvatarHtml}</div>
        <div class="message-bubble">${message}<div class="timestamp">${timestamp}</div></div>
      </div>`;
    }

    qaDiv.insertAdjacentHTML('beforeend', msgHtml);
    setTimeout(()=>{document.getElementById('scroll-anchor').scrollIntoView({behavior:'smooth'});},80);
  }

  // --- Main chat form logic (kept unchanged, using addChatMessage above) ---
  const chatForm = document.getElementById('moodChatForm');
  if (chatForm) {
    const textarea = document.getElementById('chatInput');
    const inputBar = document.getElementById('chatInputBar');
    let questionIndex = parseInt(inputBar?.dataset.questionIndex || "0", 10);
    const totalQuestions = parseInt(inputBar?.dataset.totalQuestions || "0", 10);

    chatForm.addEventListener('submit', function(e){
      e.preventDefault();
      const answer = textarea.value.trim();
      if(!answer) return;
      textarea.value = '';
      textarea.disabled = true;
      document.getElementById('sendButton').disabled = true;

      addChatMessage('user', answer, new Date().toLocaleString());
      focusChatInput();

      let isLastQuestion = false;
      if (totalQuestions > 0 && questionIndex === totalQuestions - 1) {
        isLastQuestion = true;
      }
      if (isLastQuestion) {
        document.getElementById('chatInputBar').style.display = 'none';
        document.getElementById('wait-msg').style.display = '';
      }

      fetch('/ajax/mood-analysis', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({answer: answer})
      })
      .then(resp => resp.json())
      .then(data => {
        textarea.disabled = false;
        document.getElementById('sendButton').disabled = false;
        focusChatInput();
        if(data.done){
          document.getElementById('wait-msg').style.display = 'none';
          addChatMessage('bot', '', new Date().toLocaleString(), true, data.mood_result);
          updateMoodSessionList();
          focusChatInput();
        } else if(data.next_question){
          addChatMessage('bot', data.next_question, new Date().toLocaleString());
          questionIndex++;
          if (inputBar) inputBar.dataset.questionIndex = questionIndex.toString();
          focusChatInput();
        } else if(data.reply){
          addChatMessage('bot', data.reply, new Date().toLocaleString());
          focusChatInput();
        }
      }).catch(err => {
        console.error('AJAX mood-analysis error', err);
        textarea.disabled = false;
        document.getElementById('sendButton').disabled = false;
      });
    });
  }
   function attachDeleteHandlers() {
    document.querySelectorAll('.delete-chat-btn').forEach(button => {
      button.addEventListener('click', () => {
        const sessionId = button.getAttribute('data-session-id');
        fetch(`/delete-chat/${sessionId}`, {
          method: 'DELETE',
        })
        .then(response => {
          if (response.ok) updateMoodSessionList();
          else console.error("Failed to delete chat");
        })
        .catch(error => console.error("Error deleting chat:", error));
      });
    });
  }
  attachDeleteHandlers();

  // --- Update mood session sidebar instantly ---
  function updateMoodSessionList() {
    fetch('/api/mood-session-list')
      .then(resp => resp.json())
      .then(data => {
        if (data.sessions) {
          const historyDiv = document.querySelector('.chat-history');
          let html = '';
          data.sessions.forEach(session => {
            html += `<div class="chat-history-item">
              <a href="/mood-analysis?session_id=${session.id}"
                class="chat-history-btn"
                title="${session.time}">
                ${session.topic}
              </a>
              <button class="delete-chat-btn" data-session-id="${session.id}">&times;</button>
            </div>`;
          });
          historyDiv.innerHTML = html;
          attachDeleteHandlers();
        }
      });
  }

</script>
</body>
</html>
