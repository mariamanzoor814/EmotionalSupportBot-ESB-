<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ESB Chat Interface</title>
    <link rel="icon" href="static/favicon.png" type="image/png">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="{{ url_for('static', filename='mood_analysis.css') }}">
  <!-- highlight.js CSS theme -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">

<!-- highlight.js library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


</head>
<style>
  .new-chat-btn {
  display: flex;
  align-items: center;
  gap: 1em;
  width: 98%;                   /* wider */
  margin: 1px auto;
  padding: 0.45em 1.2em;        /* less height */
  background: transparent;
  color: #fff;
  font-size: 1.08em;
  font-weight: 400;
  border: 1.5px solid #3c3f4a;
  border-radius: 10px;
  cursor: pointer;
  transition: background 0.15s, border 0.15s, box-shadow 0.15s;
  box-shadow: none;
  outline: none;
  text-align: left;
  min-height: 45px;             /* controls min height */
  max-width: 370px;             /* controls the maximum width if needed */
}

.new-chat-btn i {
  font-size: 1.15em;
  font-weight: 300;
}

.new-chat-btn:hover, .new-chat-btn:focus {
  background: #21232b;
  border-color: #55576c;
  box-shadow: 0 0 0 2px #27293a;
}



.chat-message {
  display: flex;
  flex-direction: column;
  margin-bottom: 2.2em;
}

.message-row {
  display: flex;
  align-items: flex-end;
  width: 100%;%
}

.avatar-col {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 48px;
}

.avatar-label {
  width: 38px;
  height: 38px;
  background: #b1c4df;
  color: #245;
  border-radius: 50%;
  font-weight: 700;
  font-size: 1.15em;
  display: flex;
  align-items: center;
  justify-content: center;
  border: none;
  box-shadow: 0 1px 6px rgba(0,0,0,0.10);
}

.user-avatar {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  border: 2px solid #3a7fd3;
  box-shadow: 0 1px 6px rgba(0,0,0,0.10);
}

.bot-bubble {
  background: #24678a;
  color: #e0f7fa;
  border-radius: 16px 16px 16px 8px;
  padding: 1em 1.2em;
  min-width: 200px;
  max-width: 540px;
  margin-left: 0;
  border: 1.5px solid #3fa2e5;
  font-size: 1.07em;
}

.user-bubble {
  background: #379c72;
  color: #fff;
  border-radius: 16px 16px 8px 16px;
  padding: 1em 1.2em;
  min-width: 70px;
  max-width: 340px;
  margin-right: 0.8em;
  border: 1.5px solid #2fbf7f;
  font-size: 1.07em;
  text-align: left;
  position: relative;
  box-shadow: 0 1px 6px rgba(0,0,0,0.07);
}


/* User messages: row is reversed and right-aligned */
.user-message .message-row {
  flex-direction: row;
  justify-content: flex-end;
}
.user-message .user-bubble {
  margin-left: 0;
  margin-right: 0.8em;
}
.user-message .avatar-col {
  margin-left: 0.2em;
}

/* Bot messages: left-aligned */
.bot-message .message-row {
  flex-direction: row;
  justify-content: flex-start;
}
.bot-message .bot-bubble {
  margin-left: 0.8em;
}

.bot-message .avatar-col {
  margin-right: 0.2em;
}

/* Button row always below bubble+avatar row! */
.button-row {
  display: flex;
  gap: 0.4em;
  margin-top: 0.14em;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.18s;
}

/* Align button row left for bot, right for user */
.bot-message > .button-row {
  align-self: flex-start;
  margin-left: 55px;
}
.user-message > .button-row {
  align-self: flex-end;
   margin-right: 58px;
}

.chat-message:hover .button-row {
  opacity: 1;
  pointer-events: auto;
}

/* Icon buttons */
.icon-btn {
  background: #23263a;
  color: #c7d1e4;
  border: none;
  border-radius: 50%;
  padding: 0.5em;
  width: 2.3em;
  height: 2.3em;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.18em;
  cursor: pointer;
  transition: background 0.13s, color 0.13s;
  outline: none;
}
.icon-btn:hover,
.icon-btn:focus {
  background: #38416b;
  color: #fff;
}

/* Responsive */
@media (max-width: 600px) {
  .bot-bubble, .user-bubble {
    max-width: 90vw;
    font-size: 0.97em;
  }
}

/* Inline code (like `this`) stays clean */
/* Generic code block style inside bot bubble */
.bot-bubble pre {
  overflow-x: auto;
  white-space: pre; /* Fix: prevent word-wrap */
  background: #1e4e68;
  padding: 1em;
  border-radius: 8px;
  font-size: 0.92em;
  font-family: 'Courier New', monospace;
  color: #fff;
}

/* Inner code (do not override syntax coloring) */
.bot-bubble pre code {
  background: none;
  padding: 0;
  color: inherit;
}

/* Scrollbar styling */
.bot-bubble pre::-webkit-scrollbar {
  height: 8px;
}
.bot-bubble pre::-webkit-scrollbar-track {
  background: #1e4e68;
}
.bot-bubble pre::-webkit-scrollbar-thumb {
  background: #4ab3ff;
  border-radius: 4px;
}
.bot-bubble pre::-webkit-scrollbar-thumb:hover {
  background: #3296e0;
}

/* Code block wrapper for label + button */
.code-block-wrapper {
  position: relative;
  margin-top: 1em;
  background: #1e4e68;
  border-radius: 8px;
  overflow: auto;
}

.code-lang-label {
  position: absolute;
  top: 0;
  left: 0;
  background: #3fa2e5;
  color: white;
  padding: 4px 10px;
  border-radius: 8px 0 8px 0;
  font-size: 0.75em;
  font-family: monospace;
}

.copy-btn {
  position: absolute;
  top: 4px;
  right: 6px;
  background: #3fa2e5;
  color: white;
  border: none;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 0.85em;
  cursor: pointer;
}
.copy-btn:hover {
  background: #24678a;
}

.session-menu {
  position: relative;
  display: inline-block;
}

.menu-btn {
  background: transparent;
  border: none;
  color: inherit;
  cursor: pointer;
  padding: 6px;
  border-radius: 6px;
  font-size: 1.0rem;
}
.menu-btn:focus { outline: 2px solid rgba(100,150,255,0.25); }

/* Panel now uses fixed positioning when opened to avoid clipping by overflow parents */
.menu-panel {
  display: none;
  position: absolute;
  right: 0;
  top: 36px;
  background: #1f2430;
  border: 1px solid #333846;
  box-shadow: 0 6px 18px rgba(0,0,0,0.35);
  border-radius: 8px;
  padding: 6px;
  z-index: 9999;        /* HIGH z-index to appear above everything */
  min-width: 120px;
  transform-origin: top right;
  transition: transform .12s ease, opacity .12s ease;
  opacity: 0;
  transform: translateY(-6px) scale(.98);
  pointer-events: none;
  box-sizing: border-box; 
  max-width: 320px;
}
.menu-panel.show {
  display: block;
  opacity: 1;
  transform: translateY(0) scale(1);
  pointer-events: auto;
}

/* items */
.menu-item {
  display: block;
  width: 100%;
  text-align: left;
  background: transparent;
  border: none;
  color: #d9e6ff;
  padding: 8px 10px;
  font-size: 0.95rem;
  cursor: pointer;
  border-radius: 6px;
}
.menu-item:hover { background: rgba(255,255,255,0.03); color: #fff; }

/* Firefox */
.chat-window {
  scrollbar-width: thin;
  scrollbar-color: rgba(255,255,255,0.18) transparent;
}

/* WebKit browsers */
.chat-window::-webkit-scrollbar {
  width: 8px;
}
.chat-window::-webkit-scrollbar-track {
  background: transparent;
}
.chat-window::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.18);
  border-radius: 999px;
  border: 2px solid transparent; /* gives some breathing room */
}
/* Thumb hover makes it more visible */
.chat-window::-webkit-scrollbar-thumb:hover {
  background: rgba(255,255,255,0.28);
}


</style>
<body>
<script>
  // Injected from server (escape to avoid XSS; Jinja handles escaping)
  window.profileAvatar = "{{ profile_avatar|e }}";
  window.isInitials = {{ 'true' if is_initials else 'false' }};
  window.username = "{{ username|e }}";
  window.userEmail = "{{ user_email|e }}";
  window.defaultAvatar = (!window.isInitials && window.profileAvatar) ? window.profileAvatar : "https://i.pravatar.cc/100?img=12";
</script>

  <!-- Sidebar Navigation -->
  <aside class="sidebar">
    <div class="top-section">
      <div class="logo">
        <img src="{{ url_for('static', filename='images/esb-logo.jpg') }}" alt="logo">
      </div>
      <nav class="nav-icons">
        <a href="{{ url_for('dashboard') }}" title="Dashboard"><i class="fas fa-home"></i></a>
        <a href="{{ url_for('mood_analysis') }}" title="Mood Analysis"><i class="fas fa-chart-bar"></i></a>
        <a href="{{ url_for('chat') }}" title="Chatbot"><i class="fas fa-comment-dots"></i></a>
        <a href="{{ url_for('mood_trends') }}" title="Mood Calendar"><i class="fas fa-calendar-alt"></i></a>
      </nav>
    </div>
    <!-- Sidebar bottom avatar -->
    <a href="{{ url_for('settings') }}" title="Profile Settings">
      {% if is_initials %}
        <div class="avatar avatar-initials">{{ profile_avatar }}</div>
      {% else %}
        <img src="{{ profile_avatar }}" class="avatar" alt="Profile Avatar" />
      {% endif %}
    </a>
  </aside> 

  <!-- Side Panel Options -->
  <section class="side-panel">
    <button class="new-chat-btn" onclick="location.href='{{ url_for('start_chat') }}'">
      <i class="fas fa-plus"></i> New chat
    </button>

    <div class="chat-history">
  {% if session_list %}
    {% for session in session_list %}
      <div class="chat-history-item" data-session-id="{{ session.id }}">
        <i class="fas fa-comment session-icon" aria-hidden="true"></i>

        <!-- Anchor with topic + date (topic wrapped so we can swap it with an input) -->
        <a href="{{ url_for('chat', chat_session_id=session.id) }}"
           data-session-id="{{ session.id }}"
           class="chat-history-btn{% if session.id == chat_session_id %} active{% endif %}">
          <span class="chat-topic">{{ session.topic }}</span>
          <span class="chat-history-date">{{ session.start_time.strftime('%Y-%m-%d %H:%M') }}</span>
        </a>

        <!-- Three-dot menu -->
        <div class="session-menu" aria-hidden="false">
          <button class="menu-btn" aria-haspopup="true" aria-expanded="false" title="Options">
            <i class="fas fa-ellipsis-v"></i>
          </button>
          <div class="menu-panel" role="menu" aria-hidden="true">
            <button class="menu-item rename-item" type="button" role="menuitem">Rename</button>
            <button class="menu-item delete-item" type="button" role="menuitem">Delete</button>
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="no-chats-msg">No previous chats found. Start a new conversation!</div>
  {% endif %}
</div>
    <div class="bottom-buttons">
      <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a>
      <a href="{{ url_for('feedback_form') }}"><i class="fas fa-comment-alt"></i> Feedback</a>
      <a href="{{ url_for('help_page') }}"><i class="fas fa-question-circle"></i> Help</a>
    </div>
  </section>

  <!-- Main Dashboard Area -->
  <main class="main-content" style="display:flex; flex-direction:column; height:100vh;">
    <header class="top-nav">
      <div class="logo-text">ESB</div>
      <div class="center-icons">
        <i class="fas fa-sun" id="lightModeToggle" title="Light Mode"></i>
        <i class="fas fa-moon" id="darkModeToggle" title="Dark Mode"></i>
      </div>
      <div class="right-avatar">
        {% if is_initials %}
          <div class="avatar avatar-initials">{{ profile_avatar }}</div>
        {% else %}
          <img src="{{ profile_avatar }}" alt="Profile Avatar" />
        {% endif %}
      </div>
    </header>

    <!-- Chat Messages Display (NO profile header here) -->
    <div class="chat-window" id="chatWindow">
      {% for message in chat_history %}
        <div class="chat-message {{ 'user-message' if message.sender == 'user' else 'bot-message' }}">
          <div class="message-row">
            {% if message.sender == 'user' %}
              <div class="message-bubble user-bubble">
                {{ message.message }}
              </div>
              <div class="avatar-col">
                {% if not is_initials %}
                  <img class="user-avatar" src="{{ profile_avatar }}" alt="User Avatar">
                {% else %}
                  <div class="avatar-label">{{ (username or 'U')[:1] }}</div>
                {% endif %}
              </div>
            {% else %}
              <div class="avatar-col">
                <div class="avatar-label">ESB</div>
              </div>
              <div class="message-bubble bot-bubble">
                <div class="bot-response">{{ message.message | markdown | safe }}</div>
              </div>
            {% endif %}
          </div>

          <div class="button-row">
            {% if message.sender == 'bot' %}
              <button class="icon-btn copy-button" title="Copy"><i class="fas fa-copy"></i></button>
              <button class="icon-btn speak-button" title="Speak"><i class="fas fa-volume-up"></i></button>
            {% endif %}
            <button class="icon-btn delete-message-btn" data-message-index="{{ loop.index0 }}" data-session-id="{{ chat_session_id }}" title="Delete"><i class="fas fa-trash"></i></button>
          </div>
        </div>
      {% endfor %}

      <div id="ajax-chat-messages"></div>
      <div id="scroll-anchor" style="height:80px;"></div>
    </div>

    <!-- Chat Input Container -->
    <div class="chat-input-bar">
      <form id="chatForm" class="chat-form" autocomplete="off">
        <textarea id="chatInput" class="chat-input" name="message" placeholder="Type a message..." required autofocus></textarea>
        <button type="button" id="micButton" class="mic-button" title="Record"><i class="fas fa-microphone" id="micIcon"></i></button>
        <button type="submit" class="send-button" id="sendButton" title="Send"><i class="fas fa-paper-plane"></i></button>
      </form>
    </div>
  </main>

  
<script src="{{ url_for('static', filename='chat.js') }}"></script>


</body>
</html>